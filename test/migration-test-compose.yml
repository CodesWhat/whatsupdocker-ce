services:
  # Lightweight mock OIDC provider
  mock-oidc:
    image: ghcr.io/navikt/mock-oauth2-server:2.1.10
    container_name: mock-oidc
    ports:
      - "9090:8080"
    environment:
      - SERVER_PORT=8080
      - LOG_LEVEL=DEBUG

  # TLS terminator in front of mock OIDC
  mock-oidc-tls:
    image: nginx:alpine
    container_name: mock-oidc-tls
    volumes:
      - ./migration/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./migration/tls.crt:/etc/nginx/tls.crt:ro
      - ./migration/tls.key:/etc/nginx/tls.key:ro
    depends_on:
      - mock-oidc

  # Phase 1: WUD creates session data in shared store volume
  wud:
    image: getwud/wud:latest
    container_name: wud-migration-test
    profiles: ["wud"]
    ports:
      - "3001:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - wud-store:/store
    environment:
      - WUD_AUTH_OIDC_MOCK_DISCOVERY=http://mock-oidc:8080/default/.well-known/openid-configuration
      - WUD_AUTH_OIDC_MOCK_CLIENTID=test-client
      - WUD_AUTH_OIDC_MOCK_CLIENTSECRET=test-secret
      - WUD_AUTH_OIDC_MOCK_REDIRECT=true
    depends_on:
      - mock-oidc

  # Phase 2: Drydock reads same store volume
  drydock:
    image: drydock:dev
    container_name: dd-migration-test
    profiles: ["drydock"]
    user: root
    ports:
      - "3001:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - wud-store:/store
      - ./migration/tls.crt:/usr/local/share/ca-certificates/mock-oidc-tls.crt:ro
    environment:
      - DD_RUN_AS_ROOT=true
      - DD_AUTH_OIDC_MOCK_DISCOVERY=https://mock-oidc-tls/default/.well-known/openid-configuration
      - DD_AUTH_OIDC_MOCK_CLIENTID=test-client
      - DD_AUTH_OIDC_MOCK_CLIENTSECRET=test-secret
      - DD_AUTH_OIDC_MOCK_REDIRECT=true
      - DD_PUBLIC_URL=http://localhost:3001
      - NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/mock-oidc-tls.crt
    depends_on:
      - mock-oidc-tls

volumes:
  wud-store:
